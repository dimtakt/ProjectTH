# 시연회 계획서
 152기 김기훈

- 목표 게임 : 동방 루나 나이츠
- 게임 링크 : https://store.steampowered.com/app/851100/Touhou_Luna_Nights/
- 게임 설명 : 시간 정지, 스네일(시간 느려짐) 능력의 활용을 컨셉으로 한,
            동방프로젝트 IP 기반의 2D 메트로바니아 게임

<!-- 계획 순서
1. 플레이어 기본 모션
2. 배경(튜토리얼 배경)
3. 플레이어 기본 지형 이동 가능
4. ui 배치
5. 보스 몬스터 만들기(충돌 테스트 용)
6. 플레이어와 기본 충돌처리 완성
7. 플레이어 중심의 피, 타격 이펙트 출력
8. 보스 몬스터 패턴
-->

## 01. 기초적인 프레임워크의 틀 제작 (1일차)

- 메인 cpp 파일의 wWinMain 함수 내에서의 MainGame 루프 구현
> CMainGame

- Define 에서의 기초 매크로 변수, enum, 템플릿 함수 정의
> tagInfo, tagFrame, tagLine, tagLinePoint, Safe_Delete()..
> extern HWND g_hWnd
> tagStringCmp

- 각종 클래스 / 객체들의 틀 제작
> (CObj, CScene, Designs Mgr 등...)
> [CObj] CPlayer, CMonster, CNpc / CBoss::CMonster
> [CScene] CStage1 ~ CStageN / CFail, CPause, CEnd
> CAbstractFactory
> [Managers] CCollisionMgr, CObjMgr, CLineMgr, CTileMgr, CBmpMgr, CSceneMgr, CUIMgr, CScrollMgr
> ..etc

충돌은 플레이어/몬스터 간의 충돌은 박스로, 총알과의 충돌은 원으로 처리 생각중


## 1일차 진행 중 메모

- 창의 해상도는 1280 * 720 으로 설정 (그러면 원본 게임의 리소스에서 2배로만 키우면 됨)
- CollisionMgr 을, 접촉 시 데미지를 받는 식으로 바꾸어야 하는 지 고민중, 일단 다른 것들 틀만 최대한 짜놓음
- 카메라 구현 시도중.. 참고 영상 : [YOUTUBE](https://www.youtube.com/watch?v=R45WWi8JLOg)
- 구현은 아마 된..거같기도 하고?.. 나중에 횡이동 구현할 때에
```cpp
int _rXOut;
int _rYOut;
CCameraMgr::Get_Instance()->Get_RenderPos(_rXOut, _rYOut); // 인자는 레퍼런스로 전달되어 원본값이 수정되어 반환됨
Set_Pos(_rXOut, _rYOut);
```
를 통해서 카메라 위치에 의한 이동이 잘 되는지 확인해보기.

## 1일차 결과

- 루프 구현 및 기초적인 개발 환경 세팅 완료.
- 다만 오브젝트들의 상세 틀은 짜지 못하였음.
- 리소스 편집도 당장 쓸만치는 하였으나, 덜 중요한 편집은 아직 해두지 못하였음




## 02. 플레이어의 지형 선타기, 점프 구현 (2일차)

- CLineMgr, CPlayer
> 플레이어의 점프 구현. 점프 키는 X.
> 점프 시 isJumping 변수가 true가 되며, 2차함수 그래프와 같이 Y축을 이동.
> 단, 이전 프레임보다 Y축 값이 낮아질 때 부터는 착지할 Line을 탐색
> 착지 할 Line은 플레이어와 X축이 겹치면서, Y축 값은 더 낮아야(위쪽에 있어야) 함.
> 여러 개가 있다면 그중 가장 Y축 값이 낮은(위쪽에 있는) 것으로 지정.
> 점프 착지 때, 바닥의 두께만큼 여윳값을 줘서, 바닥보다 약간 낮은 정도는 위로 올라오게 보정을 줌.


## 2일차 진행 중 메모

- 지형 선타기 및 점프 구현..을 해야 하나,
  어떻게 짤 지 감이 잡히지 않음. 팀과제와 다르게 아래나 옆에서 점프로 윗 블럭에 올라가는 그런 상황이 있으면 안됨. 막혀야함
  그럼 충돌이 발생하는 경우의 수를 타일 단위로 따로 저장한 뒤 그걸 불러와서 사용해야 하나?
  잘 모르겠다..
  일단 넘기고, 오늘의 목표를 03. 리소스를 플레이어에 반영 및 02. 점프 구현 으로 잡자.


- 플레이어 변수로 필요할만 한 게 뭐가 있지?

> isJumping : 점프 중임을 확인. 이를 통해 뭘 할 수 있지? 전같이 메이플같은 지형이면 모를 까 여기선 굳이 쓸 구석이..?
> iHp, iMp, iTp : 체력 마나 시간자원. 이건 필요함.
> fMoveSpeed : 이동 속도.
> iStopMode : 0이 평소, 1이 스네일, 2가 시간정지. 이건 enum으로 해야하나? 애초에 플레이어에 둘 필요가 없을지도?
> iCurrentSkill : 나중에 스킬 구현 시에나 필요할 것 같음.
> 등등... 나중에 생각

> 우선 map 으로 관리되어 저장될, 스프라이트의 정보를 담는 변수 그게 필요할 것 같은데..
> 일단 **키입력**부터 구현한 뒤, 정상적으로 움직이는 걸 확인해보고 해당 정보를 Key값을 통해 불러올 수 있는 싱글톤을 만들자
> 어차피 몬스터나 보스 등의 스프라이트같은 것도 생각하면, 이런 정보도 싱글톤으로 만들어서 관리하는 편이 훨씬 유용할 듯

> 키입력 구현 후, 임시용 스테이지 1-01 구현 후, 씬 매니저에서 키 입력을 통해 스테이지 1-01로 넘어가도록 한 뒤, 정상 작동 테스트
> 키입력 좌우만 구현됨. 임시용 스테이지 구현됨. 키 입력을 통해 잘 넘어가는듯.

> 문제가,
1. 잔상이 남음. (아마 배경 이미지가 없어서 그런 것 같음. 이따가 넣어서 다시 테스트해볼 것)
2. 좌 우의 이미지 반전은 아직 미구현. 조건에 따른 StretchBlt 함수를 이용해야 함
3. 상태가 지난 정도에 따른 스프라이트 프레임 변화 또한 미구현 !!!!!!!!!!!!!!

플레이어를 타겟 삼아 카메라가 이동해야 하며
지금 처음에 0, 0으로 캐릭터가 스폰됨
좌표도 좀 이상함

> ~~현재 Rect 값과 m_tFramePropCur 의 멤버변수를 통해 어떻게 잘 수정하면 될 것 같은데..~~
> ~~아니야, Update_Rect() 함수는 현재의 m_tInfo.fCX, fCY 값에 기반하여 계산되니~~
> ~~m_tInfo.fCX, fCY 를 현재 프레임의 이미지 크기에 맞게 반영시켜주면 될 것 같음.~~

> ~~수정하였으나, 움직일 때만 오른쪽 범위가 늘어나는 식으로 반영됨.~~
> ~~다시 수정해야 함. 중앙점을 기준으로 렌더 범위가 정해져야 할텐데.~~
> 수정함. Blt 함수에서 렌더는 2배 크기로 했는데, Update_Rect에서는 1배 크기 기준으로 보정하니까 안맞았던 것.
> 2배용 Update_Rect 함수를 따로 제작하여 해결



## 2일차 결과

- 테스트용 좌, 우 키입력만 구현해봄

- 각 State마다의 스프라이트 가로세로 크기도 다 다르고.. 0번째 인덱스부터 루프 돌리는걸 상정하지 않은 스프라이트도 있고..
  그래서 각 State 마다의 가로세로 길이 및 시작프레임 인덱스, 끝 프레임 인덱스 등의 정보를 담는 FRAME_PROP 구조체를 따로 둠.
  또한 CSpritePropertyMgr 라는 이름의, FRAME_PROP 구조체를 TCHAR 키 값으로 저장 및 불러오기가 가능한 싱글톤을 구현함

-  프레임 삽입에 성공함. 그러나 좌표가 어긋나는 문제 발생
- 좌표 어긋나는 문제 해결.
- 원래 생각은 StretchBlt를 통해 좌우반전을 구현하려 했으나.. 그냥 좌우반전 리소스를 추가하여 구현함





## 03. 리소스를 바탕으로 플레이어의 idle 비롯 각종 모션 대입 및 확인, 총알(칼) 구현 (3일차)

리소스를 바탕으로 플레이어 및 몬스터 모션 대입 후 확인
- CPlayer
> 플레이어의 좌 우 이동, 앉기 구현
> 플레이어의 좌 우 이동, 이동 중 반대방향으로 전환시 모션, 앉기,
> 점프 중 올라감, 점프 중 내려감, 점프 중 활공,
> 공격, 연속공격, 점프 중 횡공격, 점프 중 대각공격, 상단공격
> 시간 정지, 시간 스네일 모션 등
> ...에 따른 모션 분기 조건 구현 및 모션 적용 후 확인
> isJumping, isSitting, dwPrevAttack(마지막 공격으로부터 공격한 시간) 등 변수 정의 후 구현해야 할 듯

> m_tFrame.iCX, m_tFrame.iCY, m_tFrame.iTotal 같은 것을 로컬 변수로 둬서 관리해야할 듯. 세로로도 잘린 이미지이므로


## 3일차 진행 중 메모

오늘은 진짜 해야되는데.. 점프와 블럭 위에 올라가기 구현
점프는 그렇다 쳐도, 블럭마다 충돌 판정을 다르게 하는 건.. 여전히 어떻게 해야 할 지 잘 모르겠다

근데 점프와 블럭 위에 올라가는 것을 구현하려면.. 우선 타일 배치를 먼저 구현해야 할 것 같은데


일단 타일 먼저 해야 할 듯..?


지금 Player 의 Render 가 Update 보다 일찍 호출되는 현상 발생. 그거 이유를 찾으면 첫프레임에 이상한 좌표에 있는 것 해결될듯
> 임시로 씬의 Initialize 때 Obj의 업데이트를 호출하는 식으로 땜빵함

일단 타일 매니저로 바닥부터 만들어보고, 거기서 점프를 테스트해봐야 할 것 같은데


타일 편집 기능 만들 때, 화면이나 콘솔 창에 현재 선택된 타일의 인덱스 표시되게 하면 쉽게 편집 가능할 듯
이제 인덱스와 속성을 변화하는 기능도 구현하고...



void CEdit::Key_Input()
		// 좌클릭 시 0번 인자의 좌표에, 1번 인자의 타일 인덱스를, 2번 인자의 속성으로 변경
		// 현재 좌표 기준이 이상함. 수정해야 함
    근데 이거 프레임 작살나는데..? < 이건 작업 실수로 비정상적으로 렌더량이 많아서 그런 것 같음

    	// 현재 화면 내에 보여야 할 갯수는 정상적으로 보이는 것 같은데,
	// 문제가 세 가지 있음
	// 1. 벡터 크기가 비정상적으로 큰 것 같음 (해상도를 감안해도 타일의 사이즈가 커서, 크게 늘면 안되는데 이건좀)
	// 2. 타일이 제대로 된 간격대로 띄워지지 않음. TILESIZERATIO 의 반영이 안됨.
	// 3. 마우스 클릭 좌표가 많이 어긋남

void CTile::Initialize()
{
	m_tInfo.fCX = TILECX;
	m_tInfo.fCY = TILECY;

이 부분이 문제되는 것 같은데, m_tInfo.fX, m_tInfo.fY 는 어디서 계산을 해 주는거지?
이게 지금 제대로 된 간격으로 떨어뜨려주지 않고 있음
Update_Rect() INFO 정보에 기반하여 제대로 위치를 잡아주고 있음


렌더 위치와 클릭 위치가 이상함. 일단 타일 간격 문제는 해결하긴 했음

void CTileMgr::Render(HDC hDC)

이부분 다시 확인해보기. 여기가 원인같음
왜 m_vecTile[384] 를 불러오는거지? 0번째 인덱스를 불러와야 하는데?
아마 화면 범위 내의 타일만 렌더하도록 제한을 주는 과정에서, 제한 조건에 문제가 있는 것 같음

	// 아마 스크롤의 경우에는 기본값이 0, 0인 반면에
	// 카메라의  경우에는 기본값이 WINCX / 2, WINCY / 2 라서 생기는 문제같음
	// 일단 잘래.. 



## 04. 임시 배경 삽입 및 리소스를 바탕으로 UI 구성 (4일차)
- CUIMgr
<!-- gauge_sprite
gauge_stop
hpvar_sptite
mpvar_sprite
ui_number_sprite
time_number_sprite
level_number_sprite 등등.. -->

- 플레이어 변수 iHp, iMp, iTp, iLevel, iGold 등과 연결하여 잘 보이는지 확인
- iTimeMode (기본 / 스네일 / 정지) 변수를 추가하여 해당 변수에 따른 스프라이트도 잘 보이는지 확인
> 기본은 평소대로, 스네일 시 MOVE 가 SNAIL로 바뀌고 TP 아래에 시계추 효과 추가, 정지 시 MOVE가 SNAIL로 바뀌는 등

## 4일차 진행 중 메모

~~void CEdit::Key_Input()~~
~~확인해야 함. 여기서 마우스 좌표를 이상하게 계산 후 전달해~~줌~~

확인해서 수정 완료, 마우스 좌표도 이제 올바르게 찍힘

1. `원본 타일 대입
2. 에디터 기능 구현
3. 생성할 타일 벡터의 축소(맵이 과하게 큼) 필요

원본 게임의 타일 정보를 보았을 때 각 방의 크기는 고정된 것으로 보임

렌더가 이상하게 됨. m_iDrawID 가 초기값이 아닌 경우에 렌더가 되지 않음
~~구조체에 해당 정보가 없는 건 아니겟지. 근데 없으면 애초에 오류가 떴겠지. 렌더 순서 문제인가~~
디버그로 확인해보니 m_iDrawID 값이 0 이 아닐 때에 비정상적으로 튀었음
알고보니 Set_FrameProperty로 정보를 전달 안해줘서 생기는 문제였음


그래서 **타일 충돌원리**는 어떻게 할거냐,

나중에 충돌판정 수정 모드도 만들어야 한다. 저거 Collision_Tile 갖다가 시각적으로 보이게 하면 될 듯



## 05. 리소스를 바탕으로 배경 / 스테이지 구성 (5일차)

- CStage1 ~ CStageN
> 최초 튜토리얼 스테이지
> 원작은 1 스테이지에 20개가 넘는 구성이나, 우선은 간략하게 1-1 ~ 1-4 구성 목표
> - 1-1 이 맨 처음 스폰구역
> - 1-2 이 잡몹들 좀 있는 구역 (원작엔 나중에 나오나, 시간 정지 시계 습득 및 스킬 1~2개 배치)
> - 1-3 이 세이브 포인트 구역 (원작엔 나중에 나오나, HP MP FULL 자판기도 배치)
> - 1-4 이 보스 스테이지 (원작에서는 맵을 돌아다니며 길을 찾은 뒤 조우함)
> 메트로바니아 식과 같은 넓은 맵은 여유되면 구현


## 06. 보스 제작 및 충돌 확인 / 모션 대입 및 확인, 총알(투사체) 구현 (6일차)
- CHonMeirin::CBoss::CMonster
> 최초 등장 착지, 투사체 발사, 강한 투사체 발사, 이동, 달리기, 점프, 가드, 쓰러짐 등
> 모션 분기 구현 및 이미지 적용

## 07. 보스의 패턴 구성 (7일차)
- CHonMeirin::CBoss::CMonster
> HP는 1000.
> 패턴은 3(4)패턴을 반복.
> 0. [IDLE 패턴] 2초간 플레이어로부터 조금씩 거리를 벌림, 매 패턴 사이마다 존재
>    이 상태에서 일정 거리 밖의 투사체 감지 시, GUARD 모드 전환 후 투사체를 막음
> 1. 제자리에서 투사체 1개 발사 (DMG 25)
> 2. 점프 후 플레이어로부터 좌or우 135도or45도 각도 상단으로 이동 후,
>    플레이어를 향해 -45도or-135도 투사체 6개 발사 (DMG 25)
> 3. 빠르게 도약 후 플레이어 추적 돌진 2회 (DMG 25)
> 4. [HP 500 미만시에만 사용] 차징 후 1800ms 뒤 강력한 넓은 투사체 발사 (DMG 50)


## 08. 플레이어 조작 및 기본스킬 구현 (8일차)
- CPlayer
> - X : 점프 (꾹 누르면 활공)
> - Z : 기본공격 (꾹 누르면 차징, 차징 완료 후 떼면 스네일 모드, 이 상태에서는 플레이어를 제외한 모든 개체의 시간이 0.5배로 흐름)
> - A : 시간정지 (다시 누르면 풀림, 시간 정지 중에는 플레이어를 제외한 모든 개체의 행동 중단)
> - S : 스킬 (꾹 누른 채 방향키 위아래로 스킬 변경 가능, 변경 중에는 모든 개체의 행동 중단)

기본 공격 시 횡/대각공격은 칼날 3개, 상단 공격은 칼날 2개 발사
아래 대각 공격 시 살짝 위로 뜸

시간 정지 미사용 상태일 때, 160ms 마다 TP가 1씩 채워짐
시간 정지 상태일 때, 160ms 마다 TP이 1씩 깎임
시간 정지 상태에서 하는 기본 공격과 스킬은 MP 대신 TP를 소모함
(TP는 상단 UI 중앙의 남은 시간을 의미)


## 09. 그레이즈 시스템 구현 (9일차)

- CPlayer, CMonster
> 그레이즈 시스템 구현
그레이즈? : 가까이 가면 (판정 빡빡) 적의 그레이즈 수치를 기반으로, 해당 수치를 빼앗으며 체력을 회복
           시간 정지 상태에서 가까이 가면 (판정 널널) 대신 마나를 회복

> 일반 적, "총알"은 생성 시 부터 그레이즈 일정량의 그레이즈 수치를 가짐
> 보스는 주기적 (3000ms 생각중) 으로 그레이즈가 1씩 회복
> 흡수한 분홍 그레이즈 수치 1당 그레이즈 4 회복, 그레이즈 4 당 mp 1 회복
> 흡수한 파랑 그레이즈 수치 1당 그레이즈 12 회복, 그레이즈 6 당 hp 1 / mp 1 회복

> 그레이즈는 CGraze라는 별개의 클래스로 CObj를 상속받게 만들고
> 몬스터나 총알에 근접 시 해당 객체로부터 방사된 뒤
> 플레이어를 추적하여 이동하는 식으로 구현, 플레이어와 충돌 시 hp/mp를 회복하도록 만들어야 할 듯


## 10. 기본 몬스터 모션 적용 및 패턴 구현 (10일차)

- CMonster (CGoblin, CWolf) + will_o_wisp
> 고블린은 플레이어가 일정 거리 내에 들어올 시 추격 후 가까워지면 전방 짧은 거리에 공격하는 패턴
> 울프는 플레이어가 감지될 시 추격 후 가까워지면 짧게 준비-도약 패턴

- CMonster (CSuiko, CYadokai)
> 스이코는 갓파 몬스터로, 플레이어 발견 시 일정 거리를 벌린 후 대각선으로 도약하여 다가와 몸박함
> 야도카이는 고정형 몬스터로, 플레이어 발견 시 지팡이를 땅에 짚으며 지형을 따라가는 회오리를 소환함
> 여유되면 다른 잡몹인 suiko, yadokai 도 구현


## 11. 플레이어 특수 스킬 구현 (11일차)

- CPlayer, CUIMgr
> S 누를 시 현재 선택된 스킬 사용
> S 를 꾹 누를 시 스킬 선택 모드 진입, 선택 중에는 다른 모든 행동이 멈춤 (UI를 제외하고는 모두 정지시켜야 함)
> Auto Aim (MP 30), Stun Knife (MP 10) 두 개 구현하기 (우선 스테이지 1-2, 1-3에 배치, 맵 확장이 가능하다면 원작과 같은 위치에.)
> 여유되면 구현, 스테이지 진행에 필수는 아님


## 12. 맵 확장 (12일차)

- CScene
> 임시적인 기본 맵 4개가 아닌, 넓은 맵 구성 및 제작 시도
> 스테이지 1의 필수적인 요소들 (시계 획득, 스킬 획득, 열쇠 획득, 저장, 신사 포탈(이미지만) 등) 을 목표로 잡음
> 플레이어가 열쇠 보유중이어야만 이동 가능한 문 구현, 가능하다면 문이 열리는 모션도 구현


<!-- ## 13. 인트로 및 스토리상의 대화창 구현 (13일차)

- CStage, CUIMgr
> 게임 시작 시 인트로 구현 (플레이어와 누군가가 대화하는 것)
> 최초 스테이지에서의 표지판을 통한 플레이어에게의 설명 및 대화창 구현
> 세이브 Npc 캐릭터(akyuu) 구현 및 대화 / 모션 적용, 필수는 아님 -->


## 14. 보석 구현 (14일차)

- CMonster, CScene, CLineMgr, CCollisionMgr
> 몬스터를 잡을 시 정해진 범위 내에서 다양한 보석이 나옴
> 보석은 중력 적용을 받아 땅으로 떨어지며, 부딪히면 튕김
> 6초간만 존재, 그 뒤 삭제, 삭제 전 1초간 깜빡이는 효과


## 15. 경험치 획득 및 레벨업 시스템 구현, 최종 점검 및 빌드 (15일차)

- CPlayer, CMonster
> 몬스터를 잡을 시 경험치가 누적되며, 일정량 누적 시 레벨업함.
> 레벨 업 시 2초 간 레벨 업 이미지가 출력되며, 그 동안은 UI 제외한 모든 행동이 멈춰짐
> 여유가 된다면 구현

- 최종 점검 및 기타 디테일 작업 필요 시 백업 후 작업



**__24일 발표 예정__**
마지막 점검 21일 예정

정 노답이다 싶으면 26일 예정
23일 저녁 12시에 1차영상
다음날 오전 12시에 2차영상